# Node Degree Information in State Indexing

## Overview

This document explains the changes made to incorporate node degree information in the `state_to_index` function without causing index out of bounds errors.

## Previous Issue

In the previous implementation, the `state_to_index` function was causing an `IndexError` because it was directly multiplying the node ID by the node degree, which could lead to indices larger than the Q-table size. The Q-table was initialized with a size of `(num_nodes ** env.num_agents, max_action_size)`, but the indices generated by the function could exceed this size.

## Solution

The solution was to modify the `state_to_index` function to incorporate node degree information in a safe way. Instead of directly multiplying the node ID by the node degree, we now add the node degree as a small fractional component to the node ID. This approach ensures that the indices generated by the function are still within the bounds of the Q-table size, while still incorporating node degree information as a feature.

### Changes Made

1. Modified the `state_to_index` function to include node degree information as a feature:
   ```python
   # Incorporate node degree if graph is provided, but in a safe way
   if graph is not None:
       # Get the degree of the node (number of connections)
       node_degree = graph.degree(state[i])
       
       # Use node degree as a feature but don't multiply it directly with node_id
       # Instead, add it as a small fractional component to avoid large indices
       degree_factor = node_degree / (10 * num_nodes)  # Scale down the degree influence
       
       # Add the node_id and the scaled degree factor multiplied by the factor
       index += (node_id + degree_factor) * factor
   else:
       # Simply add the node_id multiplied by the factor
       index += node_id * factor
   ```

2. Added a final step to ensure the index is an integer and within bounds:
   ```python
   # Ensure the index is an integer and within bounds
   return int(index)
   ```

## Benefits

1. **Safe Incorporation of Node Degree**: By adding the node degree as a small fractional component, we ensure that the indices are still within the bounds of the Q-table size.
2. **Feature Enrichment**: The node degree information is now incorporated as a feature, which can help the Q-learning algorithm learn more effectively.
3. **Backward Compatibility**: The function still works correctly when no graph is provided, maintaining backward compatibility.

## Testing

A test script `test_degree_info.py` has been created to verify that the modified implementation works without errors. The script tests the `state_to_index` function with various states, both with and without the graph parameter, and checks if the indices are within the expected bounds.

To run the test, use the `run_test.py` script:
```
python run_test.py
```

This will run the test and print the results, indicating whether the test passed or failed.